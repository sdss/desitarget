#!/usr/bin/env python

from __future__ import print_function, division

import fitsio
import numpy as np

#import warnings
#warnings.simplefilter('error')

from desiutil.log import get_logger
log = get_logger()

from argparse import ArgumentParser
ap = ArgumentParser(description='Concatenate multiple FITS files into one large file. Retains the header from the FIRST listed input file')
ap.add_argument("infiles", 
                help="SEMI-COLON separated list of input files, which may have to be enclosed by quotes (e.g. 'file1;file2;file3;file4')")
ap.add_argument("outfile", 
                help="Output file name")

ns = ap.parse_args()

#ADM convert passed csv strings to lists
fns = [ fn for fn in ns.infiles.split(';') ]

#ADM read the header from the first file
fx = fitsio.FITS(fns[0])
hdr = fx[1].read_header()

#ADM concatenate the files
skies = []
for fn in fns:
    log.info('Working on file {}'.format(fn))
    skies.append(fitsio.read(fn))

skies = np.concatenate(skies)

log.info('Writing {} skies to {}'.format(len(skies), ns.outfile))

fitsio.write(ns.outfile, skies, extname='SKIES', header=hdr, clobber=True)
